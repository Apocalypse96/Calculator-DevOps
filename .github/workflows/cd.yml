# =============================================================================
# CD Pipeline - Kubernetes Deployment with Manual Trigger
# =============================================================================
# This pipeline deploys validated Docker images to Kubernetes.
# Requires manual trigger to ensure controlled releases.
# =============================================================================

name: CD Pipeline

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (SHA or "latest")'
        required: true
        default: 'latest'
        type: string
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      run_dast:
        description: 'Run DAST scan after deployment'
        required: false
        default: true
        type: boolean

# Permissions required for deployment
permissions:
  contents: read
  id-token: write

# Environment variables
env:
  IMAGE_NAME: spring-calculator
  NAMESPACE: calculator

jobs:
  # ==========================================================================
  # Pre-deployment Validation
  # Purpose: Ensure the image exists and manifests are valid
  # ==========================================================================
  validate:
    name: "Validate Deployment"
    runs-on: ubuntu-latest
    env:
      DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/spring-calculator
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Verify image exists
        run: |
          echo "Checking if image exists: ${{ env.DOCKER_IMAGE }}:${{ inputs.image_tag }}"
          docker pull ${{ env.DOCKER_IMAGE }}:${{ inputs.image_tag }}
          echo "Image verified successfully!"

      - name: Validate Kubernetes manifests (YAML syntax)
        run: |
          echo "Validating Kubernetes manifests (YAML syntax check)..."
          pip install pyyaml > /dev/null 2>&1
          for file in k8s/*.yaml; do
            if [[ "$file" == *"-local.yaml" ]]; then
              echo "Skipping $file (local development only)"
              continue
            fi
            echo "Checking $file..."
            python3 -c "import yaml; yaml.safe_load(open('$file'))" && echo "  ✓ Valid YAML"
          done
          echo "All manifests have valid YAML syntax!"

  # ==========================================================================
  # DAST (Dynamic Application Security Testing) - Placeholder
  # Purpose: Test running application for security vulnerabilities
  # Note: This is a simulation for demonstration purposes
  # ==========================================================================
  dast:
    name: "DAST Scan (Simulated)"
    needs: validate
    runs-on: ubuntu-latest
    if: inputs.run_dast == true
    steps:
      - name: DAST Scan Placeholder
        run: |
          echo "=============================================="
          echo "      DYNAMIC APPLICATION SECURITY TEST       "
          echo "=============================================="
          echo ""
          echo "In a production environment, this stage would:"
          echo ""
          echo "1. Deploy to a staging environment"
          echo "2. Run OWASP ZAP or similar DAST tool:"
          echo "   - zap-full-scan.py -t http://staging-url"
          echo "   - Nuclei vulnerability scans"
          echo "   - Burp Suite Enterprise scans"
          echo ""
          echo "3. Test for:"
          echo "   - SQL Injection vulnerabilities"
          echo "   - Cross-Site Scripting (XSS)"
          echo "   - Authentication bypasses"
          echo "   - API security issues"
          echo "   - OWASP Top 10 vulnerabilities"
          echo ""
          echo "4. Generate reports and fail on HIGH/CRITICAL"
          echo ""
          echo "=============================================="
          echo "Simulating DAST scan..."
          sleep 5
          echo "DAST scan completed (simulation)"
          echo "=============================================="

  # ==========================================================================
  # Deploy to Kubernetes
  # Purpose: Deploy the application to the target Kubernetes cluster
  # ==========================================================================
  deploy:
    name: "Deploy to Kubernetes (Dry Run)"
    needs: [validate, dast]
    if: always() && needs.validate.result == 'success' && (needs.dast.result == 'success' || needs.dast.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update deployment image tag
        run: |
          # Replace placeholder with actual image tag
          sed -i "s|IMAGE_TAG_PLACEHOLDER|${{ inputs.image_tag }}|g" k8s/deployment.yaml
          sed -i "s|\${DOCKERHUB_USERNAME}|${{ secrets.DOCKERHUB_USERNAME }}|g" k8s/deployment.yaml
          echo "Updated deployment.yaml with image tag: ${{ inputs.image_tag }}"

      - name: Validate manifests (YAML + Structure)
        run: |
          echo "=============================================="
          echo "  KUBERNETES MANIFEST VALIDATION"
          echo "=============================================="
          echo ""
          pip install pyyaml > /dev/null 2>&1

          validate_k8s_yaml() {
            local file=$1
            echo "Validating $file..."

            # Check YAML syntax
            if ! python3 -c "import yaml; yaml.safe_load(open('$file'))"; then
              echo "  ✗ Invalid YAML syntax"
              return 1
            fi

            # Check required K8s fields
            python3 << EOF
          import yaml
          import sys
          with open('$file') as f:
              doc = yaml.safe_load(f)
          required = ['apiVersion', 'kind', 'metadata']
          missing = [r for r in required if r not in doc]
          if missing:
              print(f"  ✗ Missing required fields: {missing}")
              sys.exit(1)
          print(f"  ✓ Valid ({doc['kind']})")
          EOF
          }

          for file in k8s/namespace.yaml k8s/configmap.yaml k8s/deployment.yaml k8s/service.yaml; do
            validate_k8s_yaml "$file"
          done

          echo ""
          echo "=============================================="
          echo "  ALL MANIFESTS VALIDATED SUCCESSFULLY!"
          echo "=============================================="

      - name: Show deployment manifest
        run: |
          echo "Final deployment.yaml:"
          echo "======================"
          cat k8s/deployment.yaml

  # ==========================================================================
  # Deployment Summary
  # Purpose: Show deployment information
  # ==========================================================================
  summary:
    name: "Deployment Summary"
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Create deployment summary
        env:
          DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/spring-calculator
        run: |
          echo "## CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`$DOCKER_IMAGE:${{ inputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | \`${{ env.NAMESPACE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Time | \`$(date -u +'%Y-%m-%d %H:%M:%S UTC')\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Image validated" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Manifests validated (dry-run)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Ready for deployment to real cluster" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "To deploy to a real Kubernetes cluster:" >> $GITHUB_STEP_SUMMARY
          echo "1. Add \`KUBE_CONFIG\` secret (base64 encoded kubeconfig)" >> $GITHUB_STEP_SUMMARY
          echo "2. Update the deploy job to remove dry-run mode" >> $GITHUB_STEP_SUMMARY
          echo "3. Re-run this workflow" >> $GITHUB_STEP_SUMMARY
